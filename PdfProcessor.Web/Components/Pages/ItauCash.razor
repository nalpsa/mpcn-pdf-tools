@page "/itau-cash"

<PageTitle>ItaÃº Cash Transactions - PDF Processor</PageTitle>

<div class="page-container">
  <div class="page-header">
    <div class="header-icon">ğŸŸ§</div>
    <div>
      <h1>ItaÃº - Cash Transactions</h1>
      <p class="subtitle">ExtraÃ§Ã£o de transaÃ§Ãµes em mÃºltiplas moedas (USD, EUR, BRL)</p>
    </div>
  </div>

  <div class="content-card">
    <div class="info-box info">
      <div class="info-icon">â„¹ï¸</div>
      <div>
        <strong>Formato suportado:</strong>
        <ul>
          <li>SeÃ§Ã£o: "Cash Transactions"</li>
          <li>Detecta mÃºltiplas contas automaticamente</li>
          <li>Suporta mÃºltiplas pÃ¡ginas</li>
          <li>Moedas: USD, EUR, BRL, etc.</li>
          <li>SaÃ­da: Excel com uma aba por conta</li>
        </ul>
      </div>
    </div>

    <div class="upload-section">
      <h3>ğŸ“ Selecionar Extratos do ItaÃº</h3>
      <InputFile OnChange="@HandleFileSelection" multiple accept=".pdf" class="file-input" />

      @if (selectedFiles.Count > 0)
      {
        <div class="files-list">
          <h4>Arquivos selecionados: @selectedFiles.Count</h4>
          @foreach (var file in selectedFiles)
          {
            <div class="file-item">
              <span class="file-icon">ğŸ“„</span>
              <span class="file-name">@file.Name</span>
              <span class="file-size">@FormatFileSize(file.Size)</span>
            </div>
          }
        </div>
      }
    </div>

    <div class="action-section">
      <button class="btn btn-primary" disabled="@(selectedFiles.Count == 0)" @onclick="ProcessFiles">
        ğŸŸ§ Processar ItaÃº Cash
      </button>

      <button class="btn btn-secondary" @onclick="ClearFiles">
        ğŸ—‘ï¸ Limpar
      </button>
    </div>

    @if (isProcessing)
    {
      <div class="loading">
        <div class="spinner"></div>
        <p>Extraindo transaÃ§Ãµes do ItaÃº...</p>
      </div>
    }

    @if (!string.IsNullOrEmpty(statusMessage))
    {
      <div class="alert @alertClass">
        @statusMessage
      </div>
    }
  </div>

  <div class="feature-boxes">
    <div class="feature-box">
      <div class="feature-icon">ğŸ’°</div>
      <h4>MÃºltiplas Moedas</h4>
      <p>Detecta USD, EUR, BRL automaticamente</p>
    </div>
    <div class="feature-box">
      <div class="feature-icon">ğŸ¦</div>
      <h4>MÃºltiplas Contas</h4>
      <p>Separa transaÃ§Ãµes por conta</p>
    </div>
    <div class="feature-box">
      <div class="feature-icon">ğŸ“Š</div>
      <h4>Excel Consolidado</h4>
      <p>Uma aba para cada conta detectada</p>
    </div>
  </div>
</div>

@code {
  private List<IBrowserFile> selectedFiles = new();
  private bool isProcessing = false;
  private string statusMessage = string.Empty;
  private string alertClass = string.Empty;
  private const long MaxFileSize = 16 * 1024 * 1024; // 16MB

  private void HandleFileSelection(InputFileChangeEventArgs e)
  {
    selectedFiles.Clear();
    statusMessage = string.Empty;

    foreach (var file in e.GetMultipleFiles(10))
    {
      if (file.Size > MaxFileSize)
      {
        statusMessage = $"Arquivo {file.Name} excede o tamanho mÃ¡ximo de 16MB";
        alertClass = "alert-error";
        continue;
      }

      if (!file.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
      {
        statusMessage = $"Arquivo {file.Name} nÃ£o Ã© um PDF vÃ¡lido";
        alertClass = "alert-error";
        continue;
      }

      selectedFiles.Add(file);
    }

    if (selectedFiles.Count > 0)
    {
      statusMessage = $"{selectedFiles.Count} arquivo(s) selecionado(s) com sucesso!";
      alertClass = "alert-success";
    }
  }

  private async Task ProcessFiles()
  {
    if (selectedFiles.Count == 0) return;

    isProcessing = true;
    statusMessage = "Extraindo Cash Transactions do ItaÃº...";
    alertClass = "alert-info";

    try
    {
      // TODO: Implementar chamada para a API
      await Task.Delay(3000); // SimulaÃ§Ã£o

      statusMessage = $"âœ… {selectedFiles.Count} extrato(s) processado(s) com sucesso!";
      alertClass = "alert-success";
    }
    catch (Exception ex)
    {
      statusMessage = $"âŒ Erro ao processar: {ex.Message}";
      alertClass = "alert-error";
    }
    finally
    {
      isProcessing = false;
    }
  }

  private void ClearFiles()
  {
    selectedFiles.Clear();
    statusMessage = string.Empty;
  }

  private string FormatFileSize(long bytes)
  {
    string[] sizes = { "B", "KB", "MB", "GB" };
    double len = bytes;
    int order = 0;

    while (len >= 1024 && order < sizes.Length - 1)
    {
      order++;
      len = len / 1024;
    }

    return $"{len:0.##} {sizes[order]}";
  }
}